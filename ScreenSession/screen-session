#!/bin/sh
# file: screen-session
# author: Artur Skonecki
# website: http://adb.cba.pl
# description: screen-session tools starter
# it is necessary to run screen_saver.py, and some other tools, embedded in other screen session, to be able to start it inside the target Screen session

# faster but less portable
SCRIPTPATH=$(dirname $(realpath $0))
#SCRIPTPATH=$(python -c "import os;print (os.path.split(os.path.realpath(\"$0\"))[0])")

export PYTHONPATH=$SCRIPTPATH

ret=0

if [ $# -eq 0 ]; then
    exec python $SCRIPTPATH/help.py
fi

mode=$1
shift 1 "$@"


if [ $# -ge 1 ]; then
    if [ $1 = "--help" -o $1 = "-h" ]; then
        exec python $SCRIPTPATH/help.py $mode
    fi
fi

umask 0077

scsfiledir="/tmp/screen-session-$USER"
if [ ! -d "$scsfiledir" ]; then
    mkdir -p $scsfiledir
fi

if [ "$session" = '' ]; then
    #session=`python $SCRIPTPATH/sessionname.py`
    if [ "$STY" = '' ]; then
        session='__no__session__'
    else
        session=$STY
    fi
fi

if [ $mode = "save" -o $mode = "load" -o $mode = "ls" -o $mode = "other" ]; then
    scsfile="$scsfiledir/___scspipe-$$"
    scsfiletmp="$scsfiledir/___scstmp-$$"

    argument0="logpipe=$scsfile"
    argument1="--session $session"
    argument2="--special-output $scsfiletmp"
    
    if [ -d "$scsfile" ]; then
        /bin/rm -f $scsfile
    fi
    mkfifo $scsfile
    screen -S SCREEN-SESSION_SAVER -mdc /dev/null python $SCRIPTPATH/screen_saver.py $mode $argument0  $argument1 $argument2 "$@"
    cat $scsfile
    /bin/rm -f $scsfile

    while read cmd
    do
        if [ "$cmd" = "X" ]; then
            read session
            read twin
            screen-session kill-group -S $session $twin
        elif [ "$cmd" = "R" ]; then
            read ret
        fi
    done < $scsfiletmp
    /bin/rm -f $scsfiletmp
else
    SHOWPID='1'
    REVERSE='0'
    SORT='0'
    shiftcount=0
    bSession=0
    # parse command line arguments
    while getopts ":PrsS:": OPT; do
        case "$OPT" in
        S)  session="$OPTARG"
            bSession=1
            shiftcount=`expr $shiftcount + 2`
            ;;
        P)  SHOWPID="0"
            shiftcount=`expr $shiftcount + 1`
            ;;
        r)  REVERSE="1"
            shiftcount=`expr $shiftcount + 1`
            ;;
        s)  SORT="1"
            shiftcount=`expr $shiftcount + 1`
            ;;
        esac
    done
    shift $shiftcount "$@"
    if [ $mode = "name" ]; then
        if [ $bSession -eq 0 ]; then
            session=`python $SCRIPTPATH/sessionname.py`
        fi
        exec python $SCRIPTPATH/sessionname.py $session "$@"
    elif [ $mode = "--version" -o $mode = "-v" ]; then
        exec python $SCRIPTPATH/help.py --version
    elif [ $mode = "--help" -o $mode = "-h" -o $mode = "help" -o $mode = "h" ]; then
        exec python $SCRIPTPATH/help.py "$@"
    else
        screen -S $session -X msgminwait 0
        if [ $mode = "manager" ]; then
            exec python $SCRIPTPATH/manager.py pn psession=$session "$@"
        #elif [ $mode = "manager-remote" -o $mode = "mr" ]; then
        #    python $SCRIPTPATH/manager.py pr psession=$session "$@"
        #elif [ $mode = "grab" ]; then
        #    sh $SCRIPTPATH/screen-session-grab "$@"
        elif [ $session != "__no__session__" ]; then
            if [ $mode = "group" -o $mode = "g" ]; then
                exec sh $SCRIPTPATH/win-to-group $session "$@"
            elif [ $mode = "regions" -o $mode = "r" ]; then
                exec screen -S SCREEN-SESSION_REGIONS -mdc /dev/null python $SCRIPTPATH/regions.py $session "$@"
            elif [ $mode = "nest-layout" -o $mode = "nl" -o $mode = "nest" ]; then
                if [ $# -eq 0 ]; then
                    exec python $SCRIPTPATH/help.py $mode
                else
                    exec screen -S SCREEN-SESSION_NEST -mdc /dev/null python $SCRIPTPATH/nest_layout.py $session "$@"
                fi
            elif [ $mode = "dir" -o $mode = "new" -o $mode = "new-window" ]; then
                exec python $SCRIPTPATH/new-window.py $$ $session "$@"
            elif [ $mode = "dump" -o $mode = "d" ]; then
                exec python $SCRIPTPATH/dump.py $session $SHOWPID $REVERSE $SORT "$@"
            elif [ $mode = "find-pid" -o $mode = "fp" ]; then
                exec python $SCRIPTPATH/find_pid.py $session "$@"
            elif [ $mode = "find-file" -o $mode = "ff" ]; then
                exec python $SCRIPTPATH/find_file.py $session "$@"
            elif [ $mode = "kill" -o $mode = "K" ]; then
                # screen-session kill [signal=TERM] [win=current]
                exec python $SCRIPTPATH/kill.py $session "$@"
            elif [ $mode = "kill-zombie" -o $mode = "kz" ]; then
                exec python $SCRIPTPATH/kill-zombie.py $session "$@"
            elif [ $mode = "kill-group" -o $mode = "kg" ]; then
                if [ $# -eq 0 ]; then
                    exec python $SCRIPTPATH/help.py $mode
                else
                    exec screen -S SCREEN-SESSION_KILL-GROUP -mdc /dev/null python $SCRIPTPATH/kill-group.py $session "$@"
                fi
            elif [ $mode = "renumber" ]; then
                exec python $SCRIPTPATH/renumber.py $session "$@"
            elif [ $mode = "subwindows" -o $mode = "sw" ]; then
                python $SCRIPTPATH/subwindows.py $session "$@"
            #elif [ $mode = "sort" ]; then
            #    python $SCRIPTPATH/sort.py $session "$@"
            else
                echo "No such mode: $mode"
                ret=1
            fi
        else
          ret=1
        fi
    fi
fi

if [ $ret -eq 0 ]; then
    ret=$?
fi
exit $ret
